name: Create Pre-release

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule: # Runs every Tuesday and Friday at 12:00 PM UTC
    - cron: '0 12 * * 2,5'

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write
      pull-requests: write # Required to delete releases and tags

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Cache dotnet tools
      uses: actions/cache@v4
      with:
        path: ~/.dotnet/tools
        key: ${{ runner.os }}-dotnet-tools-ilspycmd-9.1.0.7988

    - name: Install ilspycmd
      run: dotnet tool install --global ilspycmd --version 9.1.0.7988

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/DllTranslation.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Cache Pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Get Latest Game Version
      id: game_version
      shell: pwsh
      run: |
        $latest = Get-Content -Path versions.json -Raw | ConvertFrom-Json
        echo "VERSION=$($latest.version)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        echo "URL=$($latest.url)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        echo "CACHE_KEY_SUFFIX=$($latest.cache_key_suffix)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

    - name: Cache Game Data Zip
      uses: actions/cache@v4
      id: cache-gamedata-zip
      with:
        path: PortalsOfPhereon_Data.zip
        key: gamedata-zip-${{ steps.game_version.outputs.CACHE_KEY_SUFFIX }}

    - name: Download Game Data
      if: steps.cache-gamedata-zip.outputs.cache-hit != 'true'
      run: curl -L -o PortalsOfPhereon_Data.zip '${{ steps.game_version.outputs.URL }}'

    - name: Extract Game Data
      shell: bash
      run: |
        mkdir -p Managed
        unzip -j -o PortalsOfPhereon_Data.zip "PortalsOfPhereon_Data/data.unity3d" -d .
        unzip -j -o PortalsOfPhereon_Data.zip "PortalsOfPhereon_Data/Managed/*" -d Managed/

    - name: Cache Decompiled Code
      uses: actions/cache@v4
      id: cache-decompiled
      with:
        path: ./decompiled
        key: ${{ runner.os }}-decompiled-${{ steps.game_version.outputs.CACHE_KEY_SUFFIX }}

    - name: Decompile and Fix
      if: steps.cache-decompiled.outputs.cache-hit != 'true'
      shell: bash
      run: |
        mkdir -p decompiled
        cd decompiled
        ilspycmd -p -o . -r ../Managed/ -lv CSharp12_0 ../Managed/Assembly-CSharp.dll

        cd ..

        python decompile_fix.py

    - name: Install Python dependencies
      run: pip install -r requirements.txt

    - name: Run pipeline script
      shell: bash
      run: |
        ls
        ls decompiled
        cat decompiled/Assembly-CSharp.csproj
        ls Managed

        bash ./pipeline.sh
      env:
          PARATRANZ_TOKEN: ${{ secrets.PARATRANZ_TOKEN }}
          PYTHONUTF8: 1

    - name: Delete older releases
      uses: dev-drprasad/delete-older-releases@v0.3.4
      with:
        keep_latest: 5
        delete_tags: true
        delete_prerelease_only: true
        delete_tag_pattern: 'build-.*'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Prepare Release Notes
      shell: pwsh
      run: |
        $readmeContent = Get-Content -Path readme.txt -Raw
        $readmeContent = $readmeContent -replace "{GAME_VERSION}", "${{ steps.game_version.outputs.VERSION }}"
        Set-Content -Path readme.txt -Value $readmeContent

    - name: Package Release Artifacts
      run: |
        New-Item -Path PortalsOfPhereon_Data/Managed -ItemType Directory -Force
        Copy-Item -Path output_assets/data.unity3d -Destination PortalsOfPhereon_Data/data.unity3d
        Copy-Item -Path replaced/bin/Release/net40/Assembly-CSharp.dll -Destination PortalsOfPhereon_Data/Managed/Assembly-CSharp.dll
        Copy-Item -Path readme.txt -Destination ./readme.txt
        Compress-Archive -Path PortalsOfPhereon_Data/* -DestinationPath PortalsOfPhereonChineseLocalization.zip

    - name: Create Release and Upload Artifacts
      uses: softprops/action-gh-release@v2
      with:
        files: PortalsOfPhereonChineseLocalization.zip
        tag_name: build-${{ github.run_number }}
        name: "Build ${{ github.run_number }} for Game Version ${{ steps.game_version.outputs.VERSION }}"
        body: "自动化预发布构建。此汉化补丁适用于游戏版本 **${{ steps.game_version.outputs.VERSION }}**。"
        prerelease: true