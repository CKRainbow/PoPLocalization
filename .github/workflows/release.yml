name: Create Pre-release

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required to create a release

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Cache dotnet tools
      uses: actions/cache@v4
      with:
        path: ~/.dotnet/tools
        key: ${{ runner.os }}-dotnet-tools-ilspycmd-9.1.0.7988

    - name: Install ilspycmd
      run: dotnet tool install --global ilspycmd --version 9.1.0.7988

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/DllTranslation.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Cache Pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Cache Game Data Zip
      uses: actions/cache@v4
      id: cache-gamedata-zip
      with:
        path: PortalsOfPhereon_Data.zip
        key: gamedata-zip-P2aSNnft-v1

    - name: Download Game Data
      if: steps.cache-gamedata-zip.outputs.cache-hit != 'true'
      run: curl -L -o PortalsOfPhereon_Data.zip 'https://pixeldrain.com/api/file/P2aSNnft?download'

    - name: Extract Game Data
      run: |
        unzip -o PortalsOfPhereon_Data.zip
        mv PortalsOfPhereon_Data/data.unity3d .
        mkdir -p Managed
        mv PortalsOfPhereon_Data/Managed/* ./Managed/
        rm -rf PortalsOfPhereon_Data

    - name: Cache Decompiled Code
      uses: actions/cache@v4
      id: cache-decompiled
      with:
        path: ./decompiled
        key: ${{ runner.os }}-decompiled-${{ hashFiles('./Managed/Assembly-CSharp.dll') }}

    - name: Decompile and Fix
      if: steps.cache-decompiled.outputs.cache-hit != 'true'
      run: |
        mkdir -p decompiled
        cd decompiled
        ilspycmd -p -o . -r ../Managed/ -lv CSharp12_0 ../Managed/Assembly-CSharp.dll
        cd ..
        python decompile_fix.py

    - name: Install Python dependencies
      run: pip install -r requirements.txt

    - name: Run pipeline script
      run: bash ./pipeline.sh
      env:
          PARATRANZ_TOKEN: ${{ secrets.PARATRANZ_TOKEN }}

    - name: Create Release and Upload Artifacts
      uses: softprops/action-gh-release@v2
      with:
        files: |
          replaced/bin/Release/Assembly-CSharp.dll
          output_assets/data.unity3d
        tag_name: build-${{ github.run_number }}
        name: "Build ${{ github.run_number }}"
        body: "Automated pre-release build."
        prerelease: true